-module(container_parse_test).

-include_lib("eunit/include/eunit.hrl").
-include("../include/container.hrl").

parsing_container_test() ->
    Parse = rest_api_handler:container_to_parse(#container{}),
    ?assert(is_list(Parse)).

parse_inspect_test() ->
    Parse = container_builder:parse_inspect(sample(), #service{}),
    #service{entrypoint=E} = Parse,
    Container = container_builder:set_container_properties_from_inspect(sample(), Parse),
    #container{status=S} = Container,
    ?assert(S == <<"running">>),
    ?assert(E == [<<"/docker-entrypoint.sh">>]).


sample() ->
    [{'Id',<<"e4e2d65e3d30c470f7bb6726ebeb2df36c6169be79a1af68f001e43117a849f9">>},
     {'Created',<<"2021-01-28T10:11:32.81015506Z">>},
     {'Path',<<"/docker-entrypoint.sh">>},
     {'Args',[<<"zkServer.sh">>,<<"start-foreground">>]},
     {'State',[{<<"Status">>,<<"running">>},
	       {<<"Running">>,true},
	       {<<"Paused">>,false},
	       {<<"Restarting">>,false},
	       {<<"OOMKilled">>,false},
	       {<<"Dead">>,false},
	       {<<"Pid">>,3251305},
	       {<<"ExitCode">>,0},
	       {<<"Error">>,<<>>},
	       {<<"StartedAt">>,<<"2021-02-03T08:44:03.581567798Z">>},
	       {<<"FinishedAt">>,
		<<"2021-02-03T08:43:28.502147626Z">>}]},
     {'Image',<<"sha256:bfa716fa26765438a1c7c73bc261dd70b04796aa9ef90f50dd4527164b30ad9f">>},
     {'ResolvConfPath',<<"/var/lib/docker/containers/e4e2d65e3d30c470f7bb6726ebeb2df36c6169be79a1af68f001e43117a849f9/resolv.conf">>},
     {'HostnamePath',<<"/var/lib/docker/containers/e4e2d65e3d30c470f7bb6726ebeb2df36c6169be79a1af68f001e43117a849f9/hostname">>},
     {'HostsPath',<<"/var/lib/docker/containers/e4e2d65e3d30c470f7bb6726ebeb2df36c6169be79a1af68f001e43117a849f9/hosts">>},
     {'LogPath',<<"/var/lib/docker/containers/e4e2d65e3d30c470f7bb6726ebeb2df36c6169be79a1af68f001e43117a849f9/e4e2d65e3d30c470f7bb6726ebeb2df36c6169be79a1af68f001e43117a849f9-json.log">>},
     {'Name',<<"/zookeeper">>},
     {'RestartCount',0},
     {'Driver',<<"overlay2">>},
     {'Platform',<<"linux">>},
     {'MountLabel',<<>>},
     {'ProcessLabel',<<>>},
     {'AppArmorProfile',<<"docker-default">>},
     {'ExecIDs',null},
     {'HostConfig',[{<<"Binds">>,[]},
		    {<<"ContainerIDFile">>,<<>>},
		    {<<"LogConfig">>,
		     [{<<"Type">>,<<"json-file">>},
		      {<<"Config">>,
		       [{<<"max-file">>,<<"5">>},
			{<<"max-size">>,<<"10m">>}]}]},
		    {<<"NetworkMode">>,<<"host">>},
		    {<<"PortBindings">>,
		     [{<<"2181/tcp">>,
		       [[{<<"HostIp">>,<<>>},
			 {<<"HostPort">>,<<"2181">>}]]},
		      {<<"2888/tcp">>,
		       [[{<<"HostIp">>,<<>>},
			 {<<"HostPort">>,<<"2888">>}]]},
		      {<<"3888/tcp">>,
		       [[{<<"HostIp">>,<<>>},
			 {<<"HostPort">>,<<"3888">>}]]}]},
		    {<<"RestartPolicy">>,
		     [{<<"Name">>,<<"on-failure">>},
		      {<<"MaximumRetryCount">>,0}]},
		    {<<"AutoRemove">>,false},
		    {<<"VolumeDriver">>,<<>>},
		    {<<"VolumesFrom">>,[]},
		    {<<"CapAdd">>,null},
		    {<<"CapDrop">>,null},
		    {<<"Dns">>,null},
		    {<<"DnsOptions">>,null},
		    {<<"DnsSearch">>,null},
		    {<<"ExtraHosts">>,null},
		    {<<"GroupAdd">>,null},
		    {<<"IpcMode">>,<<"shareable">>},
		    {<<"Cgroup">>,<<>>},
		    {<<"Links">>,null},
		    {<<"OomScoreAdj">>,0},
		    {<<"PidMode">>,<<>>},
		    {<<"Privileged">>,false},
		    {<<"PublishAllPorts">>,false},
		    {<<"ReadonlyRootfs">>,false},
		    {<<"SecurityOpt">>,null},
		    {<<"UTSMode">>,<<>>},
		    {<<"UsernsMode">>,<<>>},
		    {<<"ShmSize">>,67108864},
		    {<<"Runtime">>,<<"runc">>},
		    {<<"ConsoleSize">>,[0,0]},
		    {<<"Isolation">>,<<>>},
		    {<<"CpuShares">>,0},
		    {<<"Memory">>,0},
		    {<<"NanoCpus">>,0},
		    {<<"CgroupParent">>,<<>>},
		    {<<"BlkioWeight">>,0},
		    {<<"BlkioWeightDevice">>,null},
		    {<<"BlkioDeviceReadBps">>,null},
		    {<<"BlkioDeviceWriteBps">>,null},
		    {<<"BlkioDeviceReadIOps">>,null},
		    {<<"BlkioDeviceWriteIOps">>,null},
		    {<<"CpuPeriod">>,0},
		    {<<"CpuQuota">>,0},
		    {<<"CpuRealtimePeriod">>,0},
		    {<<"CpuRealtimeRuntime">>,0},
		    {<<"CpusetCpus">>,<<>>},
		    {<<"CpusetMems">>,<<>>},
		    {<<"Devices">>,null},
		    {<<"DeviceCgroupRules">>,null},
		    {<<"DiskQuota">>,0},
		    {<<"KernelMemory">>,0},
		    {<<"MemoryReservation">>,0},
		    {<<"MemorySwap">>,0},
		    {<<"MemorySwappiness">>,null},
		    {<<"OomKillDisable">>,false},
		    {<<"PidsLimit">>,0},
		    {<<"Ulimits">>,null},
		    {<<"CpuCount">>,0},
		    {<<"CpuPercent">>,0},
		    {<<"IOMaximumIOps">>,0}, 
		    {<<"IOMaximumBandwidth">>,0},
		    {<<"MaskedPaths">>,
		     [<<"/proc/asound">>,<<"/proc/acpi">>,
		      <<"/proc/kcore">>,<<"/proc/keys">>,
		      <<"/proc/latency_stats">>,<<"/proc/timer_list">>,
		      <<"/proc/timer_stats">>,<<"/proc/sched_debug">>,
		      <<"/proc/scsi">>,<<"/sys/firmware">>]},
		    {<<"ReadonlyPaths">>,
		     [<<"/proc/bus">>,<<"/proc/fs">>,<<"/proc/irq">>,
		      <<"/proc/sys">>,<<"/proc/sysrq-trigger">>]}]},
     {'GraphDriver',[{<<"Data">>,
		      [{<<"LowerDir">>,
			<<"/var/lib/docker/overlay2/351b048d6edb9fd181d196ffeace990c46597f92016af1d51b481fc3e5a34358-init/diff:/var/lib/docker/overlay2/448593d4cab1980ff06d81cec964c7e3d463d8a325cdcc0c48ea39b05f2566b8/diff:/var/lib/docker/overlay2/6892ddbfe97d4c9c6a6ba71ed319d05b751d4722dd29691f822905bb09f92b89/diff:/var/lib/docker/overlay2/39d989c4d4f51b5a6036f0a77ccecdec6df312cc300587612a5ec4777af42b68/diff:/var/lib/docker/overlay2/8e17d9f5e2cf4f94708b9a5879e8a7b5b6ebf639cdbd58de5b034850a7a9016e/diff:/var/lib/docker/overlay2/b18b4e2e1f812c4d737406d0f52c1235aecffdae1e1076d59b8bafba66d4a2fe/diff:/var/lib/docker/overlay2/6b939778d0a0d28c0031fd25d35edd8ce6e05e8b90f554e2c9339645ae40ebd4/diff:/var/lib/docker/overlay2/3d849fb6799e0cf327ca5f61b98f46afa360845dab3cc912dac099a04b344f10/diff:/var/lib/docker/overlay2/4cce717e465193ce213b3cf42b2f08e44abd2f2ef4994cc6e3739109d5b396e9/diff">>},
		       {<<"MergedDir">>,
			<<"/var/lib/docker/overlay2/351b048d6edb9fd181d196ffeace990c46597f92016af1d51b481fc3e5a34358/merged">>},
		       {<<"UpperDir">>,
			<<"/var/lib/docker/overlay2/351b048d6edb9fd181d196ffeace990c46597f92016af1d51b481fc3e5a34358/diff">>},
		       {<<"WorkDir">>,
			<<"/var/lib/docker/overlay2/351b048d6edb9fd181d196ffeace990c46597f92016af1d51b481fc3e5a34358/work">>}]},
		     {<<"Name">>,<<"overlay2">>}]},
     {'Mounts',[[{<<"Type">>,<<"volume">>},
		 {<<"Name">>,
		  <<"acfe5d701aa5f8eb00faf5763dbd3dc6a54af9113803fec5ef8482fccdb8c9e4">>},
		 {<<"Source">>,
		  <<"/var/lib/docker/volumes/acfe5d701aa5f8eb00faf5763dbd3dc6a54af9113803fec5ef8482fccdb8c9e4/_data">>},
		 {<<"Destination">>,<<"/data">>}, 
		 {<<"Driver">>,<<"local">>},
		 {<<"Mode">>,<<>>},
		 {<<"RW">>,true},
		 {<<"Propagation">>,<<>>}],
		[{<<"Type">>,<<"volume">>},
		 {<<"Name">>,
		  <<"93cc40e20b2c1f50b1cc50f28372bc1c073c1d08bf2da78b7bb5d4602e2eaa6d">>},
		 {<<"Source">>,
		  <<"/var/lib/docker/volumes/93cc40e20b2c1f50b1cc50f28372bc1c073c1d08bf2da78b7bb5d4602e2eaa6d/_data">>},
		 {<<"Destination">>,<<"/datalog">>},
		 {<<"Driver">>,<<"local">>},
		 {<<"Mode">>,<<>>},
		 {<<"RW">>,true},
		 {<<"Propagation">>,<<>>}],
		[{<<"Type">>,<<"volume">>},
		 {<<"Name">>,
		  <<"4a61b7cbf1b93d0948bd3277f287fc2c4b0e7c2a5a8270405b736766967e301b">>},
		 {<<"Source">>,
		  <<"/var/lib/docker/volumes/4a61b7cbf1b93d0948bd3277f287fc2c4b0e7c2a5a8270405b736766967e301b/_data">>},
		 {<<"Destination">>,<<"/logs">>},
		 {<<"Driver">>,<<"local">>},
		 {<<"Mode">>,<<>>},
		 {<<"RW">>,true},
		 {<<"Propagation">>,<<>>}]]},
     {'Config',[{<<"Hostname">>,<<"nisbus-volta">>},
		{<<"Domainname">>,<<>>},
		{<<"User">>,<<>>},
		{<<"AttachStdin">>,false},
		{<<"AttachStdout">>,false},
		{<<"AttachStderr">>,false},
		{<<"ExposedPorts">>,
		 [{<<"2181/tcp">>,[{}]},
		  {<<"2888/tcp">>,[{}]},
		  {<<"3888/tcp">>,[{}]}]},
		{<<"Tty">>,false},
		{<<"OpenStdin">>,false},
		{<<"StdinOnce">>,false},
		{<<"Env">>,
		 [<<"ZOO_TICK_TIME=20000">>,<<"ZOO_INIT_LIMIT=10">>,
		  <<"ZOO_SYNC_LIMIT=5">>,
		  <<"ZOO_MAX_CLIENT_CNXNS=1000">>,
		  <<"JAVA_OPTS=-Xms512m -Xmx1g">>,
		  <<"PATH=/usr/local/openjdk-8/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/zookeeper-3.4.14/bin">>,
		  <<"LANG=C.UTF-8">>,
		  <<"JAVA_HOME=/usr/local/openjdk-8">>,
		  <<"JAVA_VERSION=8u275">>,<<"ZOO_CONF_DIR=/conf">>,
		  <<"ZOO_DATA_DIR=/data">>,
		  <<"ZOO_DATA_LOG_DIR=/datalog">>,
		  <<"ZOO_LOG_DIR=/logs">>,
		  <<"ZOO_AUTOPURGE_PURGEINTERVAL=0">>,
		  <<"ZOO_AUTOPURGE_SNAPRETAINCOUNT=3">>,
		  <<"ZOOCFGDIR=/conf">>]},
		{<<"Cmd">>,[<<"zkServer.sh">>,<<"start-foreground">>]},
		{<<"Image">>,
		 <<"registry.voltanet.io:4567/volta/containers/zookeeper:3.4">>},
		{<<"Volumes">>,
		 [{<<"/data">>,[{}]},
		  {<<"/datalog">>,[{}]},
		  {<<"/logs">>,[{}]}]},
		{<<"WorkingDir">>,<<"/zookeeper-3.4.14">>},
		{<<"Entrypoint">>,[<<"/docker-entrypoint.sh">>]},
		{<<"OnBuild">>,null},
		{<<"Labels">>,
		 [{<<"com.docker.compose.config-hash">>,
		   <<"fe4b879e9052f05f36c181da5b07d3f22c60d658d7f05e9b1c9c982f1d9728db">>},
		  {<<"com.docker.compose.container-number">>,<<"1">>},
		  {<<"com.docker.compose.oneoff">>,<<"False">>},
		  {<<"com.docker.compose.project">>,<<"docker">>},
		  {<<"com.docker.compose.service">>,<<"zookeeper">>},
		  {<<"com.docker.compose.slug">>,
		   <<"602ac66168c56d91620df77a6ec722ed5192c71b6dc051c236d16c95acc4e60">>},
		  {<<"com.docker.compose.version">>,<<"1.23.1">>}]}]},
     {'NetworkSettings',[{<<"Bridge">>,<<>>},
			 {<<"SandboxID">>,
			  <<"7cc5c2aaab2f58ab3245f020022caa36274ddf6f224c5a46bdbb2ac078ba6427">>},
			 {<<"HairpinMode">>,false},
			 {<<"LinkLocalIPv6Address">>,<<>>},
			 {<<"LinkLocalIPv6PrefixLen">>,0},
			 {<<"Ports">>,[{}]},
			 {<<"SandboxKey">>,
			  <<"/var/run/docker/netns/default">>},
			 {<<"SecondaryIPAddresses">>,null},
			 {<<"SecondaryIPv6Addresses">>,null},
			 {<<"EndpointID">>,<<>>},
			 {<<"Gateway">>,<<>>},
			 {<<"GlobalIPv6Address">>,<<>>}, 
			 {<<"GlobalIPv6PrefixLen">>,0},
			 {<<"IPAddress">>,<<>>},
			 {<<"IPPrefixLen">>,0},
			 {<<"IPv6Gateway">>,<<>>},
			 {<<"MacAddress">>,<<>>},
			 {<<"Networks">>,
			  [{<<"host">>,
			    [{<<"IPAMConfig">>,null},
			     {<<"Links">>,null},
			     {<<"Aliases">>,null},
			     {<<"NetworkID">>,
			      <<"d854e24fda9e53ee6564b1a991139f445bd8266049f76b5050c085e9e1d78766">>},
			     {<<"EndpointID">>,
			      <<"7754c99aba4a21255d56a343ac59b5456a9ec0fee175ace5cc48eecfe80cd800">>},
			     {<<"Gateway">>,<<>>},
			     {<<"IPAddress">>,<<>>},
			     {<<"IPPrefixLen">>,0},
			     {<<"IPv6Gateway">>,<<>>},
			     {<<"GlobalIPv6Address">>,<<>>},
			     {<<"GlobalIPv6PrefixLen">>,0},
			     {<<"MacAddress">>,<<>>},
			     {<<"DriverOpts">>,null}]}]}]}].
